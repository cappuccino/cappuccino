name: Build Testbook with fresh frameworks and manual tests & Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write       # required by deploy-pages
  id-token: write    # required by deploy-pages
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cappuccino (this repo)
        uses: actions/checkout@v4

      - name: Checkout Cappuccino-Testbook into ./testbook
        uses: actions/checkout@v4
        with:
          repository: ArgosOz/Cappuccino-Testbook
          path: testbook

      # Refresh Frameworks from dist â†’ testbook/Frameworks
      - name: Refresh Frameworks
        run: |
          set -euo pipefail
          if [ ! -d dist ]; then
            echo "âŒ dist/ not found at repo root" >&2
            exit 1
          fi
          mkdir -p testbook/Frameworks
          rm -rf testbook/Frameworks/*
          cp -a dist/. testbook/Frameworks/
          echo "Frameworks populated:" && ls -la testbook/Frameworks || true

      # Replace subdirectories inside testbook/Resources with Tests/Manual subdirectories
      - name: Sync Resources from Tests/Manual
        run: |
          set -euo pipefail
          if [ ! -d "Tests/Manual" ]; then
            echo "âŒ Tests/Manual not found at repo root" >&2
            exit 1
          fi
          mkdir -p testbook/Resources
          # Remove only immediate subdirectories (keep stray files if any)
          find testbook/Resources -mindepth 1 -maxdepth 1 -type d -print0 | xargs -0 -r rm -rf
          # Copy each immediate subdirectory from Tests/Manual â†’ testbook/Resources
          while IFS= read -r -d '' d; do
            cp -a "$d" testbook/Resources/
          done < <(find Tests/Manual -mindepth 1 -maxdepth 1 -type d -print0)
          echo "Resources now contains:" && ls -la testbook/Resources || true

      # Ensure each test Index.html includes the include path line before OBJJ_MAIN_FILE
      - name: Inject OBJJ_INCLUDE_PATHS into Index.html files
        run: |
          set -euo pipefail
          found=0
          while IFS= read -r -d '' f; do
            found=1
            if grep -q 'OBJJ_INCLUDE_PATHS' "$f"; then
              echo "Already updated: $f"
              continue
            fi
            perl -0777 -i -pe 's/OBJJ_MAIN_FILE\s*=\s*"main\.j";/OBJJ_INCLUDE_PATHS = ["..\/..\/Frameworks"];\nOBJJ_MAIN_FILE = "main.j";/i' "$f"
            perl -0777 -i -pe 's/Frameworks\/Objective-J\/Objective-J.js/\.\.\/\.\.\/Frameworks\/Objective-J\/Objective-J.js/' "$file"
            echo "Updated: $f"
          done < <(find testbook/Resources -mindepth 2 -maxdepth 2 -type f -iname "index.html" -print0)

          if [ "$found" -eq 0 ]; then
            echo "âš ï¸ No index.html files found under testbook/Resources/*/" >&2
          fi

      # Optional: prune VCS/CI metadata from the served content
      - name: Clean testbook for Pages (optional)
        run: |
          set -euo pipefail
          test -f testbook/index.html
          test -d testbook/Resources
          test -d testbook/Frameworks
          rm -rf testbook/.git testbook/.github || true
          find testbook -maxdepth 1 -type f -name ".git*" -delete || true

      - name: Upload Pages artifact (testbook/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: testbook

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: pages
      cancel-in-progress: true
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment Pages URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ toJSON(steps.deployment.outputs.page_url) }}`;
            const body = `ðŸ“„ GitHub Pages preview for this PR:\n\n${url}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
