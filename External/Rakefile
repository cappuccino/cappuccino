#!/usr/bin/env ruby

require '../common'
require 'objective-j'
require 'rake'
require 'rake/clean'

require 'fileutils'

$ENVIRONMENT_NARWHAL_PRODUCT = File.join($ENVIRONMENT_DIR, 'narwhal')
$ENVIRONMENT_BROWSERJS_PRODUCT = File.join($ENVIRONMENT_NARWHAL_PRODUCT, 'packages', 'browser')
$ENVIRONMENT_JACK_PRODUCT = File.join($ENVIRONMENT_NARWHAL_PRODUCT, 'packages', 'jack')

$ENVIRONMENT_NARWHAL_EXECUTABLE = File.join($ENVIRONMENT_BIN_DIR, 'narwhal')

file_d $ENVIRONMENT_NARWHAL_PRODUCT do
    cp_r('narwhal', $ENVIRONMENT_NARWHAL_PRODUCT)
end

file_d $ENVIRONMENT_NARWHAL_EXECUTABLE => [$ENVIRONMENT_NARWHAL_PRODUCT] do
  FileUtils.ln_sf('../narwhal/bin/narwhal', $ENVIRONMENT_NARWHAL_EXECUTABLE)
end

file_d $ENVIRONMENT_BROWSERJS_PRODUCT => [$ENVIRONMENT_NARWHAL_PRODUCT] do
    cp_r('browser.js', $ENVIRONMENT_BROWSERJS_PRODUCT)
end

file_d $ENVIRONMENT_JACK_PRODUCT => [$ENVIRONMENT_NARWHAL_PRODUCT] do
    cp_r('jack', $ENVIRONMENT_JACK_PRODUCT)
end

task :update_submodules do
    if executable_exists? "git"
        system %{cd .. && git submodule update --init}
    else
        puts "Git not installed"
        rake abort
    end
end

task :build => [:update_submodules, $ENVIRONMENT_NARWHAL_PRODUCT, $ENVIRONMENT_BROWSERJS_PRODUCT, $ENVIRONMENT_JACK_PRODUCT, $ENVIRONMENT_NARWHAL_EXECUTABLE]

CLOBBER.include($ENVIRONMENT_NARWHAL_PRODUCT, $ENVIRONMENT_BROWSERJS_PRODUCT, $ENVIRONMENT_JACK_PRODUCT, $ENVIRONMENT_NARWHAL_EXECUTABLE)
